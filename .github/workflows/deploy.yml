name: Frontend Production Deployment (Traefik + Nginx)

on:
   push:
      branches: ["main"]

# Thi·∫øt l·∫≠p m√¥i tr∆∞·ªùng m·∫∑c ƒë·ªãnh cho to√†n b·ªô Job ƒë·ªÉ l·∫•y Secret
env:
   DOCKER_IMAGE_TAG: ${{ github.run_number }}

jobs:
   # --- GIAI ƒêO·∫†N 1: BUILD & PUSH DOCKER ---
   build-and-push:
      runs-on: ubuntu-latest
      steps:
         - name: Checkout code
           uses: actions/checkout@v4

         - name: Set up Docker Buildx
           uses: docker/setup-buildx-action@v3

         - name: Login to Docker Hub
           uses: docker/login-action@v3
           with:
              username: ${{ secrets.DOCKER_USERNAME }}
              password: ${{ secrets.DOCKER_PASSWORD }}

         - name: Build and push (Forcing No-Cache for ENV changes)
           uses: docker/build-push-action@v5
           with:
              context: .
              push: true
              # ƒê·∫∑t t√™n image (s·ª≠ d·ª•ng run_number l√†m tag)
              tags: ${{ secrets.DOCKER_USERNAME }}/${{ secrets.DOCKER_IMAGE_NAME }}:${{ env.DOCKER_IMAGE_TAG }}
              # TH√äM THAM S·ªê N√ÄY ƒê·ªÇ BU·ªòC BUILD L·∫†I V√Ä KH·∫ÆC PH·ª§C L·ªñI CACHE
              no-cache: true

              # TRUY·ªÄN T·∫§T C·∫¢ BI·∫æN M√îI TR∆Ø·ªúNG VITE V√ÄO QU√Å TR√åNH BUILD DOCKER
              build-args: |
                 VITE_API_BASE_URL=${{ secrets.VITE_API_BASE_URL }}
                 VITE_GOOGLE_CLIENT_ID=${{ secrets.VITE_GOOGLE_CLIENT_ID }}
                 VITE_SOCKET_URL=${{ secrets.VITE_SOCKET_URL }}

   # --- GIAI ƒêO·∫†N 2: DEPLOY L√äN EC2 ---
   deploy:
      needs: build-and-push
      runs-on: ubuntu-latest

      steps:
         - name: Deploy to EC2
           uses: appleboy/ssh-action@v1.0.3
           with:
              host: ${{ secrets.EC2_HOST }}
              username: ${{ secrets.EC2_USER }}
              key: ${{ secrets.EC2_SSH_KEY }}
              port: ${{ secrets.EC2_SSH_PORT || '22' }}
              script: |
                 # ========================================================
                 # 1. THI·∫æT L·∫¨P BI·∫æN & L√ÄM S·∫†CH D·ªÆ LI·ªÜU
                 # ========================================================
                 VERSION="${{ env.DOCKER_IMAGE_TAG }}"
                 FULL_IMAGE="${{ secrets.DOCKER_USERNAME }}/${{ secrets.DOCKER_IMAGE_NAME }}:$VERSION"

                 CONTAINER_NAME="frontend-app" 
                 INTERNAL_PORT="80" 

                 # L·∫•y domain t·ª´ secret v√† x√≥a s·∫°ch k√Ω t·ª± l·∫°
                 RAW_DOMAIN="${{ secrets.DOMAIN_NAME }}"
                 DOMAIN_NAME=$(echo "$RAW_DOMAIN" | tr -d '[:space:]')

                 echo "üöÄ B·∫Øt ƒë·∫ßu Deploy Frontend Ver: $VERSION"
                 echo "üåê Domain s·ª≠ d·ª•ng cho Traefik: [$DOMAIN_NAME]"

                 # ========================================================
                 # 2. K√âO IMAGE & BACKUP
                 # ========================================================
                 echo "üì• K√©o image m·ªõi: $FULL_IMAGE"
                 docker pull $FULL_IMAGE

                 if [ "$(docker ps -q -f name=$CONTAINER_NAME)" ]; then
                   echo "‚ö†Ô∏è ƒêang backup container c≈©..."
                   docker rename $CONTAINER_NAME "${CONTAINER_NAME}_backup"
                   docker stop "${CONTAINER_NAME}_backup"
                 fi

                 # ========================================================
                 # 3. CH·∫†Y CONTAINER M·ªöI (TRAEFIK MODE)
                 # ========================================================
                 echo "üî• ƒêang kh·ªüi ch·∫°y container Frontend..."

                 # S·ª¨ D·ª§NG L·ªÜNH RUN D√ÄI ƒê·ªÇ KH√îNG B·ªä TR√ÄN D√íNG TRONG YAML
                 docker run -d \
                   --name $CONTAINER_NAME \
                   --network web_network \
                   --restart always \
                   -l "traefik.enable=true" \
                   -l "traefik.http.routers.$CONTAINER_NAME.rule=Host(\`$DOMAIN_NAME\`)" \
                   -l "traefik.http.routers.$CONTAINER_NAME.entrypoints=websecure" \
                   -l "traefik.http.routers.$CONTAINER_NAME.tls.certresolver=myresolver" \
                   -l "traefik.http.services.$CONTAINER_NAME.loadbalancer.server.port=$INTERNAL_PORT" \
                   $FULL_IMAGE

                 # ========================================================
                 # 4. HEALTH CHECK & ROLLBACK
                 # ========================================================
                 echo "ü©∫ ƒêang ki·ªÉm tra s·ª©c kh·ªèe ·ª©ng d·ª•ng (ch·ªù 10s)..."
                 sleep 10

                 if [ "$(docker ps -q -f name=$CONTAINER_NAME)" ]; then
                   echo "‚úÖ DEPLOY FRONTEND TH√ÄNH C√îNG! Image: $FULL_IMAGE"
                   docker rm -f "${CONTAINER_NAME}_backup" || true
                   docker image prune -a -f --filter "until=24h"
                 else
                   echo "‚ùå TH·∫§T B·∫†I! Container b·ªã crash. ƒêang Rollback..."
                   docker rm -f $CONTAINER_NAME || true
                   
                   if [ "$(docker ps -a -q -f name=${CONTAINER_NAME}_backup)" ]; then
                     docker rename "${CONTAINER_NAME}_backup" $CONTAINER_NAME
                     docker start $CONTAINER_NAME
                     echo "‚úÖ ƒê√£ kh√¥i ph·ª•c phi√™n b·∫£n c≈©."
                   fi
                   exit 1 
                 fi

         # --- G·ª¨I MAIL TH√îNG B√ÅO (T√πy ch·ªçn) ---
         - name: Send Email Status
           if: always()
           uses: dawidd6/action-send-mail@v3
           with:
              server_address: smtp.gmail.com
              server_port: 587
              secure: false
              username: ${{ secrets.MAIL_USERNAME }}
              password: ${{ secrets.MAIL_PASSWORD }}
              subject: ${{ job.status == 'success' && '‚úÖ FE DEPLOY SUCCESS' || '‚ùå FE DEPLOY FAILED' }}
              to: nvtvlog234@gmail.com
              from: GitHub Actions
              body: |
                 D·ª± √°n: Frontend ${{ github.repository }}
                 Phi√™n b·∫£n: ${{ env.DOCKER_IMAGE_TAG }}
                 Tr·∫°ng th√°i: ${{ job.status }}
                 Domain: ${{ secrets.DOMAIN_NAME }}
